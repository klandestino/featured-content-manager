"use strict";var _createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(p,m){p.customize.FeaturedAreaControl=p.customize.Control.extend({ready:function(){var n=this,i=this.container[0],l=i.querySelector("ol.featured-area"),e=i.querySelector(".add-featured-item"),r=void 0,d=new Map,t=void 0,o=void 0,s=(_createClass(a,[{key:"addItem",value:function(){var t=this,e=document.getElementById(this.element_id),n=p.template("featured-item");if(!e){if((e=document.createElement("li")).id="item_"+this.key,e.innerHTML=n(this.postData),e.querySelector(".item-delete").addEventListener("click",function(e){return t.deleteItem(e)}),e.querySelector(".handle").addEventListener("click",function(e){return t.toggleItemEdit(e)}),e.querySelector("input"))for(var i=e.querySelectorAll("input"),a=0;a<i.length;a++)i[a].addEventListener("keyup",function(e){return t.updateItem(e)});if(e.querySelector(".featured-item-image-field-upload"))for(var r=e.querySelectorAll(".featured-item-image-field-upload"),o=0;o<r.length;o++)r[o].addEventListener("click",function(e){return t.selectMedia(e)});if(e.querySelector(".featured-item-image-field-remove"))for(var s=e.querySelectorAll(".featured-item-image-field-remove"),c=0;c<s.length;c++)s[c].addEventListener("click",function(e){return t.removeMedia(e)});if(e.querySelector("textarea")&&e.querySelector("textarea").addEventListener("keyup",function(e){return t.updateItem(e)}),e.querySelector("select")&&e.querySelector("select").addEventListener("change",function(e){return t.updateItem(e)}),0!==this.postData.post_parent)l.querySelector("#item_"+this.postData.post_parent+" ol").appendChild(e);else{var u=l.querySelectorAll("li")?l.querySelectorAll("li").length:0;this.postData.menu_order=u,l.appendChild(e)}d.set(this.key,this)}}},{key:"getPostData",value:function(){return this.postData.featured_area=this.featured_area,this.postData}},{key:"setPostData",value:function(e,t){this.postData[e]=t,this.setSettings()}},{key:"selectMedia",value:function(e){var n=this;e.preventDefault();var i=m(e.target).parent(".featured-item-image-field-container"),a=p.media({title:"Select or upload image",button:{text:"Set image"},multiple:!1}).on("select",function(){var e=a.state().get("selection").first().toJSON(),t=i.find("input");i.find("img").attr("src",e.url).show(),t.val(e.id),i.find(".featured-item-image-field-remove").show(),i.find(".featured-item-image-field-upload").hide(),n.setPostData(t.attr("name"),e.id)}).open()}},{key:"removeMedia",value:function(e){e.preventDefault();var t=m(e.target).parent(".featured-item-image-field-container"),n=t.find("input");n.val(""),t.find("img").attr("src","#").hide(),t.find(".featured-item-image-field-remove").hide(),t.find(".featured-item-image-field-upload").show(),this.setPostData(n.attr("name"),"")}},{key:"toggleItemEdit",value:function(e){e.preventDefault();var t=document.getElementById(this.element_id),n=i.querySelector("li.open");null!==n&&n.classList.remove("open"),n==t?t.classList.remove("open"):t.classList.add("open")}},{key:"updateItem",value:function(e){var t=e.target.name,n=e.target.value;this.setPostData(t,n)}},{key:"setSettings",value:function(){r.setSettings()}},{key:"getChildren",value:function(){var n=this,i=[];return d.forEach(function(e){var t=e.getPostData();t.post_parent==n.key&&i.push(t.ID)}),i}},{key:"deleteItem",value:function(){var t=this,e=l.querySelector("#"+this.element_id);if(e){var n=this.getChildren();0!==n.length&&n.forEach(function(e){d.get(parseInt(e)).deleteItem()}),e.remove()}window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items/"+this.key,{method:"DELETE",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin"}).then(function(e){return e.json()}).then(function(e){d.delete(parseInt(t.key)),r.setSettings()})}}]),a);function a(e){_classCallCheck(this,a),this.key=e.ID,this.postData=e,this.featured_area=n.id,this.element_id="item_"+e.ID,this.addItem()}var c=(_createClass(u,[{key:"open",value:function(){document.querySelector("body").classList.add("adding-featured-items"),this.active=!0,this.search("")}},{key:"close",value:function(){document.querySelector("body").classList.remove("adding-featured-items"),this.active=!1,this.clear()}},{key:"toggle",value:function(){document.querySelector("body").classList.contains("adding-featured-items")?this.close():this.open()}},{key:"clear",value:function(){this.active=!1,document.getElementById("featured-items-search").value=""}},{key:"onInputChange",value:function(e){e.preventDefault();var t=e.target.value;this.search(t)}},{key:"search",value:function(t){var a=this;if(this.active){var n=document.querySelector("body");clearTimeout(o),o=setTimeout(function(){n.classList.add("searching");var e=document.querySelectorAll(".search-item-tpl");[].forEach.call(e,function(e){e.remove()}),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"posts?s="+t).then(function(e){return e.json()}).then(function(e){n.classList.remove("searching");var i=p.template("search-item");e.forEach(function(t,e){var n=document.createElement("li");n.id=t.ID,n.classList.add("search-item-tpl"),n.innerHTML=i(t),document.querySelector("#available-featured-items-list").appendChild(n).addEventListener("click",function(e){t.featured_area=a.featured_area,window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin",body:JSON.stringify({obj:t})}).then(function(e){return e.json()}).then(function(e){e.forEach(function(e){new s(e)}),r.setSettings()})})})})},500)}}}]),u);function u(){var t=this;_classCallCheck(this,u),this.active=!0,this.featured_area=n.id,this.searchPanel=document.getElementById("available-featured-items"),this.search(""),document.getElementById("featured-items-search").addEventListener("keyup",function(e){return t.onInputChange(e)}),document.addEventListener("click",function(e){e.target.classList.contains("add-featured-item")||function e(t,n){if(!t.parentNode)return!1;if(0<=t.className.split(" ").indexOf(n))return!0;return e(t.parentNode,n)}(e.target,"accordion-container")||t.close()})}var f=(_createClass(h,[{key:"loadSettings",value:function(){var t=n.setting.get();try{t=JSON.parse(t)}catch(e){t=t}t.sort(function(e,t){return e.menu_order-t.menu_order}),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin",body:JSON.stringify({settings:t})}).then(function(e){return e.json()}).then(function(e){e.forEach(function(e){null!=e&&new s(e)}),window.MSInputMethodContext&&document.documentMode&&p.customize.previewer.refresh()})}},{key:"setSettings",value:function(){clearTimeout(t),t=setTimeout(function(){var e=n.setting.get(),t=[];d.forEach(function(e){t.push(e.getPostData())}),t.sort(function(e,t){return e.menu_order-t.menu_order}),t!=e&&(n.setting.set(JSON.stringify(t)),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"settings",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin",body:n.setting.get()}).then(function(e){return e.json()}).then(function(e){}))},500)}},{key:"updateOrder",value:function(e){new Map,e.forEach(function(e,t){var n=parseInt(e.id),i=d.get(n);i.setPostData("menu_order",t),i.setPostData("post_parent",e.parent_id?e.parent_id:0)})}},{key:"toggleSearchPanel",value:function(e){e.preventDefault(),this.searchPanel||(this.searchPanel=new c),this.searchPanel.toggle()}},{key:"addItem",value:function(){event.preventDefault(),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items").then(function(e){return e.json()}).then(function(e){new s(e[0])})}},{key:"initSortable",value:function(){var n=this;m(l).nestedSortable({handle:".handle",items:"li",toleranceElement:"> div",maxLevels:2,excludeRoot:!0,forcePlaceholderSize:!0,placeholder:"placeholder",stop:function(e){var t=m(l).nestedSortable("toArray",{attribute:"id"});n.updateOrder(t)}})}}]),h);function h(){var t=this;_classCallCheck(this,h),this.searchPanel=null,e.addEventListener("click",function(e){return t.toggleSearchPanel(e)}),this.initSortable()}(r=new f).loadSettings()}}),m.extend(p.customize.controlConstructor,{"featured-area":p.customize.FeaturedAreaControl})}(wp,jQuery);