"use strict";var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(p){p.customize.FeaturedAreaControl=p.customize.Control.extend({ready:function(){var n=this,i=this.container[0],r=i.querySelector("ol.nested-sortable"),e=i.querySelector(".add-featured-item"),t=p.i18n,a=t.__,o=(t._x,t._n,t._nx,void 0),s=void 0,c=void 0,l=void 0,u=void 0,d=(_createClass(f,[{key:"addItem",value:function(){var t=this,e=function(e){var t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.firstChild}(p.template("featured-item")(this.data));e.querySelector(".button-link-delete").addEventListener("click",function(e){return t.deleteItem(e)}),e.querySelector(".featured-item-edit").addEventListener("click",function(e){return t.toggleItemEdit(e)}),void 0!==this.parent?this.list.querySelector('[data-id="'+this.parent+'"] ol').appendChild(e):this.list.appendChild(e),"object"===_typeof(this.data.children)&&this.data.children.forEach(function(e){new f(e,t.list,t.data.id)})}},{key:"toggleItemEdit",value:function(e){e.preventDefault();var t=r.querySelector('[data-id="'+this.data.id+'"]'),n=r.querySelector("li.open");null!==n&&n.classList.remove("open"),n==t?t.classList.remove("open"):t.classList.add("open")}},{key:"deleteItem",value:function(){r.querySelector('[data-id="'+this.data.id+'"]').remove(),o.setSettings()}}]),f);function f(e,t,n){_classCallCheck(this,f),this.data=e,this.list=t,this.parent=n,this.addItem()}var h=(_createClass(m,[{key:"open",value:function(){document.querySelector("body").classList.add("adding-featured-items"),this.active=!0,this.search("")}},{key:"close",value:function(){document.querySelector("body").classList.remove("adding-featured-items"),this.active=!1,this.clear()}},{key:"toggle",value:function(){document.querySelector("body").classList.contains("adding-featured-items")?this.close():this.open()}},{key:"clear",value:function(){this.active=!1,document.getElementById("featured-items-search-input").value=""}},{key:"onInputChange",value:function(e){e.preventDefault();var t=e.target.value;this.search(t)}},{key:"search",value:function(n){var r=this;this.active&&(clearTimeout(c),c=setTimeout(function(){var t=document.querySelector("body");t.classList.add("searching");var e=r.searchResult.querySelectorAll(".featured-item-tpl");[].forEach.call(e,function(e){e.remove()}),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"posts?s="+n+"&type="+u,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin"}).then(function(e){return e.json()}).then(function(e){t.classList.remove("searching"),e.forEach(function(e,t){new d(e,r.searchResult)})})},500))}}]),m);function m(){var t=this;_classCallCheck(this,m),this.active=!0,this.searchResult=document.getElementById("featured-items-search-list"),this.search(""),document.getElementById("featured-items-search-input").addEventListener("keyup",function(e){return t.onInputChange(e)}),document.addEventListener("click",function(e){e.target.classList.contains("add-featured-item")||function e(t,n){if(!t.parentNode)return!1;if(0<=t.className.split(" ").indexOf(n))return!0;return e(t.parentNode,n)}(e.target,"featured-item-container")||t.close()}),document.querySelector("#featured-items-search-panel .customize-section-back").addEventListener("click",function(e){return t.close()})}var v=(_createClass(y,[{key:"loadSettings",value:function(){var t=n.setting.get();try{t=JSON.parse(t)}catch(e){t=t}(t=t.slice(0,l)).forEach(function(e){null!=e&&new d(e,r)})}},{key:"getDataAttributes",value:function(n){return Object.keys(n).reduce(function(e,t){return e[t]=n[t],e},{})}},{key:"setSettings",value:function(){var t=this;clearTimeout(s),s=setTimeout(function(){var e=t.serialize(r);n.setting.set(JSON.stringify(e)),p.customize.previewer.refresh()},500)}},{key:"serialize",value:function(e){var t=[],n=[].slice.call(e.children);for(var r in n){var i=n[r].querySelector(".nested-sortable"),a=this.getDataAttributes(n[r].dataset);t.push(_extends({},a,{children:i?this.serialize(i):[]}))}return t}},{key:"isDuplicate",value:function(e){var t=!1;return 1<r.querySelectorAll('[data-id="'+e.id+'"]').length&&(t=!0),t}},{key:"isFull",value:function(){var e=r.querySelectorAll(".featured-item-tpl");return l<e.length}},{key:"toggleSearchPanel",value:function(e){e.preventDefault(),this.searchPanel||(this.searchPanel=new h),this.searchPanel.toggle()}},{key:"initSortables",value:function(){for(var t=this,e=[].slice.call(i.querySelectorAll(".nested-sortable")),n=0;n<e.length;n++)this.nestedSortables[n]=new Sortable(e[n],{group:"nested",swapThreshold:.65,emptyInsertThreshold:42,onSort:function(e){t.setSettings()},onAdd:function(e){t.isDuplicate(e.clone.dataset)?(e.item.remove(),t.addErrorNotification("This item already exist in the selected featured area.")):t.isFull()&&(e.item.remove(),t.addErrorNotification("The selected featured area is full."))}});var r=document.querySelector("#featured-items-search-list");new Sortable(r,{group:{name:"nested",pull:"clone",put:!1},sort:!1})}},{key:"addErrorNotification",value:function(e){p.customize.notifications.add("error",new p.customize.Notification("error",{dismissible:!0,message:a(e,"featured-content-manager"),type:"error"}))}}]),y);function y(){var t=this;_classCallCheck(this,y),this.nestedSortables=[],l=r.dataset.max,u=r.dataset.type,e.addEventListener("click",function(e){return t.toggleSearchPanel(e)}),this.loadSettings(),this.initSortables()}o=new v}}),_.extend(p.customize.controlConstructor,{"featured-area":p.customize.FeaturedAreaControl})}(wp,jQuery);