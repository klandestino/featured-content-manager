"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(v,p){v.customize.FeaturedAreaControl=v.customize.Control.extend({ready:function(){var i=this,n=this.container[0],c=n.querySelector("ol.featured-area"),e=n.querySelector(".add-featured-item"),t=v.i18n,r=t.__,s=(t._x,t._n,t._nx,void 0),a=void 0,o=void 0,l=(_createClass(u,[{key:"addItem",value:function(){var t=this,e=v.template("featured-item");if(this.element=document.getElementById(this.element_id),!this.element){for(var i in this.element=document.createElement("li"),this.element.classList.add(this.postData.post_status),this.element.id="item_"+this.id,this.postData)this.element.setAttribute("data-"+i,this.postData[i]);if(this.element.innerHTML=e(this.postData),this.element.querySelector(".item-delete").addEventListener("click",function(e){return t.deleteItem(e)}),this.element.querySelector(".handle").addEventListener("click",function(e){return t.toggleItemEdit(e)}),this.element.querySelector("input"))for(var n=this.element.querySelectorAll("input"),a=0;a<n.length;a++)n[a].addEventListener("keyup",function(e){return t.updateItem(e)});if(this.element.querySelector(".featured-item-image-field-upload"))for(var r=this.element.querySelectorAll(".featured-item-image-field-upload"),s=0;s<r.length;s++)r[s].addEventListener("click",function(e){return t.selectMedia(e)});if(this.element.querySelector(".featured-item-image-field-remove"))for(var o=this.element.querySelectorAll(".featured-item-image-field-remove"),l=0;l<o.length;l++)o[l].addEventListener("click",function(e){return t.removeMedia(e)});this.element.querySelector("textarea")&&this.element.querySelector("textarea").addEventListener("keyup",function(e){return t.updateItem(e)}),this.element.querySelector("select")&&this.element.querySelector("select").addEventListener("change",function(e){return t.updateItem(e)}),void 0!==this.parent?c.querySelector("#item_"+this.parent+" ol").appendChild(this.element):c.appendChild(this.element),"object"===_typeof(this.postData.children)&&this.postData.children.forEach(function(e){new u(e,t.id)})}}},{key:"toggleItemEdit",value:function(e){e.preventDefault();var t=document.getElementById(this.element_id),i=n.querySelector("li.open");null!==i&&i.classList.remove("open"),i==t?t.classList.remove("open"):t.classList.add("open")}},{key:"selectMedia",value:function(e){var i=this;e.preventDefault();var n=p(e.target).parent(".featured-item-image-field-container"),a=v.media({title:"Select or upload image",button:{text:"Set image"},multiple:!1}).on("select",function(){var e=a.state().get("selection").first().toJSON(),t=n.find("input");n.find("img").attr("src",e.url).show(),t.val(e.id),n.find(".featured-item-image-field-remove").show(),n.find(".featured-item-image-field-upload").hide(),i.setPostData(t.attr("name"),e.id),i.setPostData(t.attr("name")+"_src",e.url)}).open()}},{key:"removeMedia",value:function(e){e.preventDefault();var t=p(e.target).parent(".featured-item-image-field-container"),i=t.find("input");i.val(""),t.find("img").attr("src","#").hide(),t.find(".featured-item-image-field-remove").hide(),t.find(".featured-item-image-field-upload").show(),this.setPostData(i.attr("name"),""),this.setPostData(i.attr("name")+"_src","")}},{key:"updateItem",value:function(e){e.target.name,e.target.value,this.setPostData(e.target.name,e.target.value)}},{key:"setPostData",value:function(e,t){p(this.element).data(e,t),this.element.setAttribute("data-"+e,t),this.setSettings()}},{key:"setSettings",value:function(){s.setSettings()}},{key:"deleteItem",value:function(){c.querySelector("#"+this.element_id).remove(),this.setSettings()}}]),u);function u(e,t){_classCallCheck(this,u),this.id=e.id,this.postData=e,this.element_id="item_"+e.id,this.parent=t,this.element=null,this.addItem()}var d=(_createClass(m,[{key:"open",value:function(){document.querySelector("body").classList.add("adding-featured-items"),this.active=!0,this.search("")}},{key:"close",value:function(){document.querySelector("body").classList.remove("adding-featured-items"),this.active=!1,this.clear()}},{key:"toggle",value:function(){document.querySelector("body").classList.contains("adding-featured-items")?this.close():this.open()}},{key:"clear",value:function(){this.active=!1,document.getElementById("featured-items-search").value=""}},{key:"onInputChange",value:function(e){e.preventDefault();var t=e.target.value;this.search(t)}},{key:"search",value:function(t){var a=this;if(this.active){var i=document.querySelector("body");clearTimeout(o),o=setTimeout(function(){i.classList.add("searching");var e=document.querySelectorAll(".search-item-tpl");[].forEach.call(e,function(e){e.remove()}),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"posts?s="+t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin"}).then(function(e){return e.json()}).then(function(e){i.classList.remove("searching");var n=v.template("search-item");e.forEach(function(t,e){var i=document.createElement("li");i.id=t.ID,i.classList.add("search-item-tpl"),i.innerHTML=n(t),document.querySelector("#available-featured-items-list").appendChild(i).addEventListener("click",function(e){t.featured_area=a.featured_area,s.doesExist(t)?v.customize.notifications.add("error",new v.customize.Notification("error",{dismissible:!0,message:r("This post already exist in the selected featured area!","featured-content-manager"),type:"error"})):new l(t)})})})},500)}}}]),m);function m(){var t=this;_classCallCheck(this,m),this.active=!0,this.featured_area=i.id,this.searchPanel=document.getElementById("available-featured-items"),this.search(""),document.getElementById("featured-items-search").addEventListener("keyup",function(e){return t.onInputChange(e)}),document.addEventListener("click",function(e){e.target.classList.contains("add-featured-item")||function e(t,i){if(!t.parentNode)return!1;if(0<=t.className.split(" ").indexOf(i))return!0;return e(t.parentNode,i)}(e.target,"accordion-container")||t.close()})}var f=(_createClass(h,[{key:"loadSettings",value:function(){var t=i.setting.get();try{t=JSON.parse(t)}catch(e){t=t}t.forEach(function(e){null!=e&&new l(e)})}},{key:"setSettings",value:function(){clearTimeout(a),a=setTimeout(function(){var e=p(c).nestedSortable("toHierarchy");console.log(e),i.setting.set(JSON.stringify(e)),v.customize.previewer.refresh()},500)}},{key:"updateOrder",value:function(e){this.setSettings()}},{key:"doesExist",value:function(e){var t=!1;return null!=c.querySelector("#item_"+e.ID)&&(t=!0),t}},{key:"toggleSearchPanel",value:function(e){e.preventDefault(),this.searchPanel||(this.searchPanel=new d),this.searchPanel.toggle()}},{key:"initSortable",value:function(){var i=this;p(c).nestedSortable({handle:".handle",items:"li",toleranceElement:"> div",maxLevels:2,excludeRoot:!0,forcePlaceholderSize:!0,placeholder:"placeholder",stop:function(e){var t=p(c).nestedSortable("toHierarchy",{attribute:"id"});i.updateOrder(t)}})}}]),h);function h(){var t=this;_classCallCheck(this,h),this.searchPanel=null,e.addEventListener("click",function(e){return t.toggleSearchPanel(e)}),this.loadSettings(),this.initSortable()}s=new f}}),p.extend(v.customize.controlConstructor,{"featured-area":v.customize.FeaturedAreaControl})}(wp,jQuery);