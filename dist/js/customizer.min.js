"use strict";var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(y){y.customize.FeaturedAreaControl=y.customize.Control.extend({ready:function(){var i=this,e=this.container[0],u=e.querySelector("ol.nested-sortable"),n=e.querySelector(".add-featured-item"),t=y.i18n,r=t.__,s=(t._x,t._n,t._nx,void 0),a=void 0,l=void 0,o=(_createClass(c,[{key:"addItem",value:function(){var t=this,e=y.template("featured-item");if(this.element=u.querySelector('[data-id="'+this.id+'"]'),!this.element){for(var i in this.element=document.createElement("li"),this.element.id=this.element_id,this.element.classList.add(this.postData.post_status),this.postData)"post_content"!==i&&this.element.setAttribute("data-"+i,this.postData[i]);if(this.element.innerHTML=e(this.postData),this.element.querySelector(".item-delete").addEventListener("click",function(e){return t.deleteItem(e)}),this.element.querySelector(".handle").addEventListener("click",function(e){return t.toggleItemEdit(e)}),this.element.querySelector("input"))for(var n=this.element.querySelectorAll("input"),a=0;a<n.length;a++)n[a].addEventListener("keyup",function(e){return t.updateItem(e)});if(this.element.querySelector(".featured-item-image-field-upload"))for(var r=this.element.querySelectorAll(".featured-item-image-field-upload"),s=0;s<r.length;s++)r[s].addEventListener("click",function(e){return t.selectMedia(e)});if(this.element.querySelector(".featured-item-image-field-remove"))for(var l=this.element.querySelectorAll(".featured-item-image-field-remove"),o=0;o<l.length;o++)l[o].addEventListener("click",function(e){return t.removeMedia(e)});this.element.querySelector("textarea")&&this.element.querySelector("textarea").addEventListener("keyup",function(e){return t.updateItem(e)}),this.element.querySelector("select")&&this.element.querySelector("select").addEventListener("change",function(e){return t.updateItem(e)}),void 0!==this.parent?u.querySelector('[data-id="'+this.parent+'"] ol').appendChild(this.element):u.appendChild(this.element),"object"===_typeof(this.postData.children)&&this.postData.children.forEach(function(e){new c(e,t.id)})}}},{key:"toggleItemEdit",value:function(e){e.preventDefault();var t=u.querySelector('[data-id="'+this.id+'"]'),i=u.querySelector("li.open");null!==i&&i.classList.remove("open"),i==t?t.classList.remove("open"):t.classList.add("open")}},{key:"selectMedia",value:function(e){var i=this;e.preventDefault();var n=e.target.parentNode,a=y.media({title:"Select or upload image",button:{text:"Set image"},multiple:!1}).on("select",function(){var e=a.state().get("selection").first().toJSON(),t=n.querySelector("input").getAttribute("name");n.querySelector("img").setAttribute("src",e.url),n.querySelector("img").style.display="inline",n.querySelector("input").value=e.id,n.querySelector(".featured-item-image-field-remove").style.display="inline",n.querySelector(".featured-item-image-field-upload").style.display="none",i.setPostData(t,e.id),i.setPostData(t+"_src",e.url)}).open()}},{key:"removeMedia",value:function(e){e.preventDefault();var t=e.target.parentNode,i=t.querySelector("input").getAttribute("name");t.querySelector("input").value="",t.querySelector("img").setAttribute("src","#"),t.querySelector("img").style.display="none",t.querySelector(".featured-item-image-field-remove").style.display="none",t.querySelector(".featured-item-image-field-upload").style.display="inline",this.setPostData(i,""),this.setPostData(i+"_src","")}},{key:"updateItem",value:function(e){e.target.name,e.target.value,this.setPostData(e.target.name,e.target.value)}},{key:"setPostData",value:function(e,t){this.element.setAttribute("data-"+e,t),this.setSettings()}},{key:"setSettings",value:function(){s.setSettings()}},{key:"deleteItem",value:function(){u.querySelector('[data-id="'+this.id+'"]').remove(),this.setSettings()}}]),c);function c(e,t){_classCallCheck(this,c),e.hasOwnProperty("original_post_id")?(this.id=e.original_post_id,e.id=this.id):e.hasOwnProperty("id")?this.id=e.id:this.id=null,this.postData=e,this.parent=t,this.element=null,this.element_id=i.id+"_item_"+this.id,this.addItem()}var d=(_createClass(h,[{key:"open",value:function(){document.querySelector("body").classList.add("adding-featured-items"),this.active=!0,this.search("")}},{key:"close",value:function(){document.querySelector("body").classList.remove("adding-featured-items"),this.active=!1,this.clear()}},{key:"toggle",value:function(){document.querySelector("body").classList.contains("adding-featured-items")?this.close():this.open()}},{key:"clear",value:function(){this.active=!1,document.getElementById("featured-items-search").value=""}},{key:"onInputChange",value:function(e){e.preventDefault();var t=e.target.value;this.search(t)}},{key:"search",value:function(t){var a=this;if(this.active){var i=document.querySelector("body");clearTimeout(l),l=setTimeout(function(){i.classList.add("searching");var e=document.querySelectorAll(".search-item-tpl");[].forEach.call(e,function(e){e.remove()}),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"posts?s="+t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin"}).then(function(e){return e.json()}).then(function(e){i.classList.remove("searching");var n=y.template("search-item");e.forEach(function(t,e){var i=document.createElement("li");i.id=t.id,i.classList.add("search-item-tpl"),i.innerHTML=n(t),document.querySelector("#available-featured-items-list").appendChild(i).addEventListener("click",function(e){t.featured_area=a.featured_area,s.doesExist(t)?y.customize.notifications.add("error",new y.customize.Notification("error",{dismissible:!0,message:r("This post already exist in the selected featured area!","featured-content-manager"),type:"error"})):s.isFull()?y.customize.notifications.add("error",new y.customize.Notification("error",{dismissible:!0,message:r("This featured area allready contains maximum number of items!","featured-content-manager"),type:"error"})):(new o(t),s.setSettings())})})})},500)}}}]),h);function h(){var t=this;_classCallCheck(this,h),this.active=!0,this.featured_area=i.id,this.searchPanel=document.getElementById("available-featured-items"),this.search(""),document.getElementById("featured-items-search").addEventListener("keyup",function(e){return t.onInputChange(e)}),document.addEventListener("click",function(e){e.target.classList.contains("add-featured-item")||function e(t,i){if(!t.parentNode)return!1;if(0<=t.className.split(" ").indexOf(i))return!0;return e(t.parentNode,i)}(e.target,"accordion-container")||t.close()})}var m=(_createClass(f,[{key:"loadSettings",value:function(){var t=i.setting.get();try{t=JSON.parse(t)}catch(e){t=t}(t=t.slice(0,this.max)).forEach(function(e){null!=e&&new o(e)})}},{key:"getDataAttributes",value:function(i){return Object.keys(i).reduce(function(e,t){return e[t]=i[t],e},{})}},{key:"setSettings",value:function(){var t=this;clearTimeout(a),a=setTimeout(function(){var e=t.serialize(u);i.setting.set(JSON.stringify(e)),y.customize.previewer.refresh()},500)}},{key:"serialize",value:function(e){var t=[],i=[].slice.call(e.children);for(var n in i){var a=i[n].querySelector(".nested-sortable"),r=this.getDataAttributes(i[n].dataset);t.push(_extends({},r,{children:a?this.serialize(a):[]}))}return t}},{key:"updateOrder",value:function(){this.setSettings()}},{key:"doesExist",value:function(e){var t=!1;return null!=u.querySelector('[data-id="'+e.id+'"]')&&(t=!0),t}},{key:"isFull",value:function(){return s.max<=u.children.length}},{key:"toggleSearchPanel",value:function(e){e.preventDefault(),this.searchPanel||(this.searchPanel=new d),this.searchPanel.toggle()}},{key:"initSortable",value:function(){for(var t=this,e=[].slice.call(document.querySelectorAll(".nested-sortable")),i=0;i<e.length;i++)this.nestedSortables[i]=new Sortable(e[i],{group:"nested",swapThreshold:.65,emptyInsertThreshold:42,onSort:function(e){t.updateOrder()}})}}]),f);function f(){var t=this;_classCallCheck(this,f),this.sortable=null,this.nestedSortables=[],this.searchPanel=null,this.max=u.dataset.max,n.addEventListener("click",function(e){return t.toggleSearchPanel(e)}),this.loadSettings(),this.initSortable()}s=new m}}),_.extend(y.customize.controlConstructor,{"featured-area":y.customize.FeaturedAreaControl})}(wp,jQuery);