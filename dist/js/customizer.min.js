"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e,t){e.customize.FeaturedAreaControl=e.customize.Control.extend({ready:function(){var n=this,i=this.container[0],a=i.querySelector("ol.featured-area"),r=i.querySelector(".add-featured-item"),o=void 0,s=new Map,c=void 0,u=void 0,l=function(){function r(e){_classCallCheck(this,r),this.key=e.ID,this.postData=e,this.featured_area=n.id,this.element_id="item_"+e.ID,this.addItem()}return _createClass(r,[{key:"addItem",value:function(){var t=this,n=document.getElementById(this.element_id),i=e.template("featured-item");if(!n){if((n=document.createElement("li")).id="item_"+this.key,n.innerHTML=i(this.postData),n.querySelector(".item-delete").addEventListener("click",function(e){return t.deleteItem(e)}),n.querySelector(".handle").addEventListener("click",function(e){return t.toggleItemEdit(e)}),n.querySelector("input"))for(var r=n.querySelectorAll("input"),o=0;o<r.length;o++)r[o].addEventListener("keyup",function(e){return t.updateItem(e)});if(n.querySelector(".featured-item-image-field-upload"))for(var c=n.querySelectorAll(".featured-item-image-field-upload"),u=0;u<c.length;u++)c[u].addEventListener("click",function(e){return t.selectMedia(e)});if(n.querySelector(".featured-item-image-field-remove"))for(var l=n.querySelectorAll(".featured-item-image-field-remove"),d=0;d<l.length;d++)l[d].addEventListener("click",function(e){return t.removeMedia(e)});if(n.querySelector("textarea")&&n.querySelector("textarea").addEventListener("keyup",function(e){return t.updateItem(e)}),n.querySelector("select")&&n.querySelector("select").addEventListener("change",function(e){return t.updateItem(e)}),0!==this.postData.post_parent){a.querySelector("#item_"+this.postData.post_parent+" ol").appendChild(n)}else{var f=a.querySelectorAll("li")?a.querySelectorAll("li").length:0;this.postData.menu_order=f,a.appendChild(n)}s.set(this.key,this)}}},{key:"getPostData",value:function(){return this.postData.featured_area=this.featured_area,this.postData}},{key:"setPostData",value:function(e,t){this.postData[e]=t,this.setSettings()}},{key:"selectMedia",value:function(n){var i=this;n.preventDefault();var a=t(n.target).parent(".featured-item-image-field-container"),r=e.media({title:"Select or upload image",button:{text:"Set image"},multiple:!1}).on("select",function(){var e=r.state().get("selection").first().toJSON(),t=a.find("input");a.find("img").attr("src",e.url).show(),t.val(e.id),a.find(".featured-item-image-field-remove").show(),a.find(".featured-item-image-field-upload").hide(),i.setPostData(t.attr("name"),e.id)}).open()}},{key:"removeMedia",value:function(e){e.preventDefault();var n=t(e.target).parent(".featured-item-image-field-container"),i=n.find("input");i.val(""),n.find("img").attr("src","#").hide(),n.find(".featured-item-image-field-remove").hide(),n.find(".featured-item-image-field-upload").show(),this.setPostData(i.attr("name"),"")}},{key:"toggleItemEdit",value:function(e){e.preventDefault();var t=document.getElementById(this.element_id),n=i.querySelector("li.open");null!==n&&n.classList.remove("open"),n==t?t.classList.remove("open"):t.classList.add("open")}},{key:"updateItem",value:function(e){var t=e.target.name,n=e.target.value;this.setPostData(t,n)}},{key:"setSettings",value:function(){o.setSettings()}},{key:"getChildren",value:function(){var e=this,t=[];return s.forEach(function(n){var i=n.getPostData();i.post_parent==e.key&&t.push(i.ID)}),t}},{key:"deleteItem",value:function(){var e=this,t=a.querySelector("#"+this.element_id);if(t){var n=this.getChildren();0!==n.length&&n.forEach(function(e){s.get(parseInt(e)).deleteItem()}),t.remove()}window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items/"+this.key,{method:"DELETE",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin"}).then(function(e){return e.json()}).then(function(t){s.delete(parseInt(e.key)),o.setSettings()})}}]),r}(),d=function(){function t(){var e=this;_classCallCheck(this,t),this.active=!0,this.featured_area=n.id,this.searchPanel=document.getElementById("available-featured-items"),this.search(""),document.getElementById("featured-items-search").addEventListener("keyup",function(t){return e.onInputChange(t)}),document.addEventListener("click",function(t){t.target.classList.contains("add-featured-item")||function e(t,n){if(!t.parentNode)return!1;if(t.className.split(" ").indexOf(n)>=0)return!0;return e(t.parentNode,n)}(t.target,"accordion-container")||e.close()})}return _createClass(t,[{key:"open",value:function(){document.querySelector("body").classList.add("adding-featured-items"),this.active=!0,this.search("")}},{key:"close",value:function(){document.querySelector("body").classList.remove("adding-featured-items"),this.active=!1,this.clear()}},{key:"toggle",value:function(){document.querySelector("body").classList.contains("adding-featured-items")?this.close():this.open()}},{key:"clear",value:function(){this.active=!1,document.getElementById("featured-items-search").value=""}},{key:"onInputChange",value:function(e){e.preventDefault();var t=e.target.value;this.search(t)}},{key:"search",value:function(t){var n=this;if(this.active){var i=document.querySelector("body");clearTimeout(u),u=setTimeout(function(){i.classList.add("searching");var a=document.querySelectorAll(".search-item-tpl");[].forEach.call(a,function(e){e.remove()}),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"posts?s="+t).then(function(e){return e.json()}).then(function(t){i.classList.remove("searching");var a=e.template("search-item");t.forEach(function(e,t){var i=document.createElement("li");i.id=e.ID,i.classList.add("search-item-tpl"),i.innerHTML=a(e),document.querySelector("#available-featured-items-list").appendChild(i).addEventListener("click",function(t){e.featured_area=n.featured_area,window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin",body:JSON.stringify({obj:e})}).then(function(e){return e.json()}).then(function(e){e.forEach(function(e){new l(e)}),o.setSettings()})})})})},500)}}}]),t}(),f=function(){function i(){var e=this;_classCallCheck(this,i),this.searchPanel=null,r.addEventListener("click",function(t){return e.toggleSearchPanel(t)}),this.initSortable()}return _createClass(i,[{key:"loadSettings",value:function(){var t=JSON.parse(n.setting.get());t.sort(function(e,t){return e.menu_order-t.menu_order}),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin",body:JSON.stringify({settings:t})}).then(function(e){return e.json()}).then(function(t){t.forEach(function(e){null!=e&&new l(e)}),window.MSInputMethodContext&&document.documentMode&&e.customize.previewer.refresh()})}},{key:"setSettings",value:function(){clearTimeout(c),c=setTimeout(function(){var e=n.setting.get(),t=[];s.forEach(function(e){t.push(e.getPostData())}),t.sort(function(e,t){return e.menu_order-t.menu_order}),t!=e&&(n.setting.set(JSON.stringify(t)),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"settings",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":wpApiSettings.nonce},credentials:"same-origin",body:n.setting.get()}).then(function(e){return e.json()}).then(function(e){}))},500)}},{key:"updateOrder",value:function(e){new Map;e.forEach(function(e,t){var n=parseInt(e.id),i=s.get(n);i.setPostData("menu_order",t),i.setPostData("post_parent",e.parent_id?e.parent_id:0)})}},{key:"toggleSearchPanel",value:function(e){e.preventDefault(),this.searchPanel?this.searchPanel.toggle():(this.searchPanel=new d,this.searchPanel.toggle())}},{key:"addItem",value:function(){event.preventDefault(),window.fetch(wpApiSettings.root+wpFeaturedContentApiSettings.base+"items").then(function(e){return e.json()}).then(function(e){new l(e[0])})}},{key:"initSortable",value:function(){var e=this;t(a).nestedSortable({handle:".handle",items:"li",toleranceElement:"> div",maxLevels:2,excludeRoot:!0,forcePlaceholderSize:!0,placeholder:"placeholder",stop:function(n){var i=t(a).nestedSortable("toArray",{attribute:"id"});e.updateOrder(i)}})}}]),i}();(o=new f).loadSettings()}}),t.extend(e.customize.controlConstructor,{"featured-area":e.customize.FeaturedAreaControl})}(wp,jQuery);